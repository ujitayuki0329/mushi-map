// 都道府県判定のキャッシュ（緯度・経度の丸め値から都道府県へのマッピング）
const prefectureCache: Map<string, string> = new Map();

// 緯度・経度を丸めてキャッシュキーを生成（0.01度 = 約1kmの精度）
const getCacheKey = (lat: number, lng: number): string => {
  return `${Math.round(lat * 100) / 100}_${Math.round(lng * 100) / 100}`;
};

// 緯度・経度から都道府県を判定する関数（同期版、より詳細な境界データを使用）
export const getPrefectureFromCoordinates = (lat: number, lng: number): string => {
  // キャッシュをチェック
  const cacheKey = getCacheKey(lat, lng);
  if (prefectureCache.has(cacheKey)) {
    return prefectureCache.get(cacheKey)!;
  }
  
  // より詳細な境界データを使用した判定
  const prefecture = getPrefectureFromCoordinatesDetailed(lat, lng);
  
  // キャッシュに保存
  prefectureCache.set(cacheKey, prefecture);
  
  return prefecture;
};

// より詳細な境界データを使用した判定関数
// 判定順序: より具体的な範囲を持つ都道府県を先に判定
const getPrefectureFromCoordinatesDetailed = (lat: number, lng: number): string => {
  
  // ========== 北海道・東北地方 ==========
  
  // 青森県（北海道より先に判定、より具体的な範囲で）
  // 青森県の範囲: 北は約41.51度（大間崎）、南は約40.2度、東は約141.9度、西は約139.5度
  if (lat >= 40.2 && lat <= 41.6 && lng >= 139.5 && lng <= 141.9) {
    // 境界付近（lat > 41.4）の場合は経度も考慮
    if (lat > 41.4) {
      // 津軽海峡の西側（本州側、lng < 141.0）は青森県
      if (lng < 141.0) {
        return '青森県';
      }
    } else {
      // 41.4度以南は確実に青森県（本州側）
      return '青森県';
    }
  }
  
  // 北海道（青森県の判定後に、より正確な範囲で）
  if (lat >= 41.3 && lat <= 45.5 && lng >= 139.0 && lng <= 146.0) {
    // 青森県と重複しない範囲を確認
    if (lat < 41.6 && lng < 141.0) {
      return '青森県';
    }
    return '北海道';
  }
  
  // 秋田県（青森県の南、岩手県の西）
  if (lat >= 38.5 && lat <= 40.5 && lng >= 139.5 && lng <= 141.0) {
    // 青森県と重複しない
    if (lat < 40.2) {
      return '秋田県';
    }
  }
  
  // 岩手県（秋田県の東、宮城県の北）
  if (lat >= 38.5 && lat <= 40.5 && lng >= 140.5 && lng <= 142.0) {
    // 秋田県と重複しない範囲
    if (lng >= 141.0 || lat >= 39.0) {
      return '岩手県';
    }
  }
  
  // 山形県（秋田県の南、福島県の北）
  if (lat >= 37.5 && lat <= 39.0 && lng >= 139.5 && lng <= 140.5) {
    // 秋田県と重複しない
    if (lat < 38.5) {
      return '山形県';
    }
  }
  
  // 宮城県（岩手県の南、福島県の東）
  if (lat >= 37.5 && lat <= 39.0 && lng >= 140.5 && lng <= 141.5) {
    // 岩手県と重複しない
    if (lat < 38.5 || lng < 141.0) {
      return '宮城県';
    }
  }
  
  // 福島県（山形県・宮城県の南、関東地方の北）
  if (lat >= 36.5 && lat <= 38.0 && lng >= 139.5 && lng <= 141.0) {
    // 山形県、宮城県と重複しない
    if (lat < 37.5) {
      return '福島県';
    }
  }
  
  // ========== 関東地方 ==========
  
  // 東京都（より具体的な範囲を先に判定）
  if (lat >= 35.3 && lat <= 35.9 && lng >= 138.7 && lng <= 139.9) {
    return '東京都';
  }
  
  // 神奈川県（東京都の南、相模湾側）
  if (lat >= 35.0 && lat <= 35.7 && lng >= 138.5 && lng <= 139.5) {
    // 東京都と重複しない
    if (!(lat >= 35.3 && lat <= 35.9 && lng >= 138.7 && lng <= 139.9)) {
      return '神奈川県';
    }
  }
  
  // 埼玉県（東京都の北）
  if (lat >= 35.5 && lat <= 36.5 && lng >= 138.5 && lng <= 139.8) {
    // 東京都と重複しない範囲
    if (!(lat >= 35.3 && lat <= 35.9 && lng >= 138.7 && lng <= 139.9)) {
      return '埼玉県';
    }
  }
  
  // 千葉県（東京都の東、東京湾・太平洋側）
  if (lat >= 35.0 && lat <= 36.0 && lng >= 139.5 && lng <= 140.9) {
    // 東京都、神奈川県、埼玉県の範囲と重複しない
    const isTokyo = lat >= 35.3 && lat <= 35.9 && lng >= 138.7 && lng <= 139.9;
    const isKanagawa = lat >= 35.0 && lat <= 35.7 && lng >= 138.5 && lng <= 139.5;
    const isSaitama = lat >= 35.5 && lat <= 36.5 && lng >= 138.5 && lng <= 139.8;
    
    if (!isTokyo && !isKanagawa && !isSaitama) {
      // 東京湾の西側境界を考慮
      if (lng >= 139.8 || (lng >= 139.5 && lat >= 35.2)) {
        return '千葉県';
      }
    }
  }
  
  // 茨城県（千葉県の北、埼玉県の東）
  if (lat >= 35.5 && lat <= 36.8 && lng >= 139.5 && lng <= 140.8) {
    // 千葉県、埼玉県と重複しない範囲
    const isChiba = lat >= 35.0 && lat <= 36.0 && lng >= 139.5 && lng <= 140.9 && 
                     !(lat >= 35.3 && lat <= 35.9 && lng >= 138.7 && lng <= 139.9) &&
                     !(lat >= 35.0 && lat <= 35.7 && lng >= 138.5 && lng <= 139.5) &&
                     !(lat >= 35.5 && lat <= 36.5 && lng >= 138.5 && lng <= 139.8);
    const isSaitama = lat >= 35.5 && lat <= 36.5 && lng >= 138.5 && lng <= 139.8;
    
    if (!isChiba && !isSaitama) {
      return '茨城県';
    }
  }
  
  // 栃木県（茨城県の西、群馬県の東、埼玉県の北）
  if (lat >= 36.0 && lat <= 37.0 && lng >= 139.0 && lng <= 140.0) {
    // 茨城県、埼玉県と重複しない
    if (lng < 139.5 || lat < 36.5) {
      return '栃木県';
    }
  }
  
  // 群馬県（埼玉県の北、栃木県の西、新潟県の南）
  if (lat >= 36.0 && lat <= 36.8 && lng >= 138.5 && lng <= 139.5) {
    // 埼玉県、栃木県と重複しない
    if (lat < 36.5 || lng < 139.0) {
      return '群馬県';
    }
  }
  
  // ========== 中部地方 ==========
  
  // 新潟県（群馬県の北、長野県の東）
  if (lat >= 36.5 && lat <= 38.5 && lng >= 137.5 && lng <= 139.5) {
    // 群馬県と重複しない
    if (lat >= 37.0 || lng >= 138.5) {
      return '新潟県';
    }
  }
  
  // 富山県（新潟県の西、石川県の東）
  if (lat >= 36.0 && lat <= 37.0 && lng >= 136.5 && lng <= 137.5) {
    // 新潟県と重複しない
    if (lng < 137.5) {
      return '富山県';
    }
  }
  
  // 石川県（富山県の西、福井県の北）
  if (lat >= 36.0 && lat <= 37.5 && lng >= 136.0 && lng <= 137.5) {
    // 富山県と重複しない
    if (lng < 136.5 || lat < 37.0) {
      return '石川県';
    }
  }
  
  // 福井県（石川県の南、滋賀県の北）
  if (lat >= 35.5 && lat <= 36.5 && lng >= 135.5 && lng <= 136.5) {
    // 石川県と重複しない
    if (lat < 36.0 || lng < 136.0) {
      return '福井県';
    }
  }
  
  // 山梨県（神奈川県の北、長野県の東、静岡県の北）
  if (lat >= 35.0 && lat <= 36.0 && lng >= 138.0 && lng <= 139.0) {
    // 神奈川県と重複しない
    if (lat >= 35.3 || lng >= 138.5) {
      return '山梨県';
    }
  }
  
  // 長野県（新潟県の西、群馬県の西、山梨県の西、岐阜県の東）
  if (lat >= 35.5 && lat <= 37.0 && lng >= 137.5 && lng <= 138.5) {
    // 新潟県、群馬県、山梨県と重複しない
    if (lng < 138.0 || lat < 36.5) {
      return '長野県';
    }
  }
  
  // 岐阜県（長野県の西、愛知県の北、三重県の北）
  if (lat >= 35.0 && lat <= 36.5 && lng >= 136.5 && lng <= 137.5) {
    // 長野県、福井県と重複しない
    if (lng < 137.5 || lat < 36.0) {
      return '岐阜県';
    }
  }
  
  // 静岡県（神奈川県の西、山梨県の南、愛知県の東）
  if (lat >= 34.5 && lat <= 35.5 && lng >= 137.5 && lng <= 139.0) {
    // 神奈川県、山梨県と重複しない
    if (lng < 138.5 || lat < 35.3) {
      return '静岡県';
    }
  }
  
  // 愛知県（静岡県の西、岐阜県の南、三重県の東）
  if (lat >= 34.5 && lat <= 35.5 && lng >= 136.5 && lng <= 137.5) {
    // 静岡県、岐阜県と重複しない
    if (lng < 137.5 || lat < 35.3) {
      return '愛知県';
    }
  }
  
  // 三重県（愛知県の西、滋賀県の南、奈良県の東）
  if (lat >= 33.5 && lat <= 35.0 && lng >= 135.5 && lng <= 136.8) {
    // 愛知県、岐阜県、滋賀県と重複しない
    if (lat < 35.0 || lng < 136.5) {
      return '三重県';
    }
  }
  
  // ========== 近畿地方 ==========
  
  // 滋賀県（福井県の南、三重県の北、京都府の東）
  if (lat >= 34.5 && lat <= 35.5 && lng >= 135.5 && lng <= 136.5) {
    // 福井県、三重県と重複しない
    if (lat < 35.0 || lng < 136.0) {
      return '滋賀県';
    }
  }
  
  // 京都府（滋賀県の西、大阪府の北、兵庫県の東）
  if (lat >= 34.5 && lat <= 35.5 && lng >= 135.0 && lng <= 136.0) {
    // 滋賀県と重複しない
    if (lng < 135.5 || lat < 35.0) {
      return '京都府';
    }
  }
  
  // 大阪府（京都府の南、兵庫県の東、奈良県の西）
  if (lat >= 34.3 && lat <= 34.9 && lng >= 135.2 && lng <= 135.8) {
    // 京都府、兵庫県、奈良県と重複しない
    return '大阪府';
  }
  
  // 兵庫県（京都府の西、大阪府の西、鳥取県の南）
  if (lat >= 34.0 && lat <= 35.5 && lng >= 134.0 && lng <= 135.5) {
    // 京都府、大阪府と重複しない
    if (lng < 135.2 || lat < 34.9) {
      return '兵庫県';
    }
  }
  
  // 奈良県（大阪府の東、三重県の西、和歌山県の北）
  if (lat >= 34.0 && lat <= 34.8 && lng >= 135.5 && lng <= 136.0) {
    // 大阪府、三重県と重複しない
    if (lng < 135.8 || lat < 34.5) {
      return '奈良県';
    }
  }
  
  // 和歌山県（奈良県の南、三重県の南）
  if (lat >= 33.5 && lat <= 34.5 && lng >= 135.0 && lng <= 136.0) {
    // 奈良県、三重県と重複しない
    if (lat < 34.0 || lng < 135.5) {
      return '和歌山県';
    }
  }
  
  // ========== 中国地方 ==========
  
  // 鳥取県（兵庫県の北、島根県の東、岡山県の北）
  if (lat >= 35.0 && lat <= 35.8 && lng >= 133.5 && lng <= 134.5) {
    // 兵庫県と重複しない
    if (lat < 35.5 || lng < 134.0) {
      return '鳥取県';
    }
  }
  
  // 島根県（鳥取県の西、広島県の北）
  if (lat >= 34.5 && lat <= 36.0 && lng >= 131.5 && lng <= 133.5) {
    // 鳥取県と重複しない
    if (lng < 133.5 || lat < 35.8) {
      return '島根県';
    }
  }
  
  // 岡山県（鳥取県の南、広島県の東、香川県の北）
  if (lat >= 34.5 && lat <= 35.5 && lng >= 133.5 && lng <= 134.5) {
    // 鳥取県と重複しない
    if (lat < 35.0 || lng < 134.0) {
      return '岡山県';
    }
  }
  
  // 広島県（島根県の南、岡山県の西、山口県の東）
  if (lat >= 34.0 && lat <= 35.0 && lng >= 132.0 && lng <= 133.5) {
    // 島根県、岡山県と重複しない
    if (lng < 133.0 || lat < 34.5) {
      return '広島県';
    }
  }
  
  // 山口県（広島県の西、福岡県の東）
  if (lat >= 33.5 && lat <= 34.8 && lng >= 130.5 && lng <= 132.0) {
    // 広島県と重複しない
    if (lng < 132.0 || lat < 34.0) {
      return '山口県';
    }
  }
  
  // ========== 四国地方 ==========
  
  // 徳島県（香川県の東、高知県の北、和歌山県の南）
  if (lat >= 33.5 && lat <= 34.5 && lng >= 133.5 && lng <= 134.5) {
    // 和歌山県と重複しない
    if (lat < 34.0 || lng < 134.0) {
      return '徳島県';
    }
  }
  
  // 香川県（徳島県の西、愛媛県の東、岡山県の南）
  if (lat >= 34.0 && lat <= 34.5 && lng >= 133.5 && lng <= 134.5) {
    // 徳島県、岡山県と重複しない
    if (lng < 134.0 || lat < 34.3) {
      return '香川県';
    }
  }
  
  // 愛媛県（香川県の西、高知県の北、広島県の南）
  if (lat >= 32.5 && lat <= 34.5 && lng >= 132.5 && lng <= 133.5) {
    // 香川県、広島県と重複しない
    if (lng < 133.5 || lat < 34.0) {
      return '愛媛県';
    }
  }
  
  // 高知県（徳島県の南、愛媛県の南）
  if (lat >= 32.5 && lat <= 34.0 && lng >= 132.5 && lng <= 134.0) {
    // 徳島県、愛媛県と重複しない
    if (lat < 33.5 || lng < 133.5) {
      return '高知県';
    }
  }
  
  // ========== 九州地方 ==========
  
  // 福岡県（山口県の西、佐賀県の東）
  if (lat >= 33.0 && lat <= 34.0 && lng >= 130.0 && lng <= 131.0) {
    // 山口県と重複しない
    if (lng < 130.5 || lat < 33.5) {
      return '福岡県';
    }
  }
  
  // 佐賀県（福岡県の西、長崎県の東）
  if (lat >= 33.0 && lat <= 33.8 && lng >= 129.5 && lng <= 130.5) {
    // 福岡県と重複しない
    if (lng < 130.0 || lat < 33.5) {
      return '佐賀県';
    }
  }
  
  // 長崎県（佐賀県の西、熊本県の北）
  if (lat >= 32.5 && lat <= 34.5 && lng >= 128.5 && lng <= 130.0) {
    // 佐賀県と重複しない
    if (lng < 129.5 || lat < 33.8) {
      return '長崎県';
    }
  }
  
  // 熊本県（長崎県の南、大分県の西、宮崎県の北）
  if (lat >= 32.0 && lat <= 33.5 && lng >= 130.0 && lng <= 131.5) {
    // 長崎県と重複しない
    if (lat < 32.5 || lng < 130.5) {
      return '熊本県';
    }
  }
  
  // 大分県（福岡県の南、熊本県の東、宮崎県の北）
  if (lat >= 32.5 && lat <= 33.8 && lng >= 130.5 && lng <= 132.0) {
    // 福岡県、熊本県と重複しない
    if (lat < 33.0 || lng < 131.0) {
      return '大分県';
    }
  }
  
  // 宮崎県（熊本県の南、大分県の南、鹿児島県の東）
  if (lat >= 31.5 && lat <= 32.5 && lng >= 130.5 && lng <= 132.0) {
    // 熊本県、大分県と重複しない
    if (lat < 32.0 || lng < 131.5) {
      return '宮崎県';
    }
  }
  
  // 鹿児島県（宮崎県の西、熊本県の南）
  if (lat >= 30.5 && lat <= 32.0 && lng >= 129.5 && lng <= 131.0) {
    // 宮崎県、熊本県と重複しない
    if (lat < 31.5 || lng < 130.5) {
      return '鹿児島県';
    }
  }
  
  // ========== 沖縄地方 ==========
  
  // 沖縄県
  if (lat >= 24.0 && lat <= 27.0 && lng >= 123.0 && lng <= 130.0) {
    return '沖縄県';
  }
  
  // 判定できない場合は「不明」
  return '不明';
};

// タイムスタンプから季節を取得
export const getSeasonFromTimestamp = (timestamp: number): string => {
  const date = new Date(timestamp);
  const month = date.getMonth() + 1; // 0-11なので+1
  
  if (month >= 3 && month <= 5) {
    return '春';
  } else if (month >= 6 && month <= 8) {
    return '夏';
  } else if (month >= 9 && month <= 11) {
    return '秋';
  } else {
    return '冬';
  }
};
